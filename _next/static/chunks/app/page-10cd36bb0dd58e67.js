(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{9552:function(e,n,r){Promise.resolve().then(r.bind(r,6774))},6774:function(e,n,r){"use strict";r.r(n),r.d(n,{default:function(){return h}});var t,c,o=r(7437),s=r(2265),i=r(6042),l=r(5566);let a=null!==(t=l.env.NEXT_PUBLIC_MQTT_URL)&&void 0!==t?t:"wss://test.mosquitto.org:8081/mqtt",u=null!==(c=l.env.NEXT_PUBLIC_MQTT_TOPIC)&&void 0!==c?c:"device/ESP32-D15644",d=[{label:"30 THB",amount:30,drop:3},{label:"40 THB",amount:40,drop:4},{label:"50 THB",amount:50,drop:5}];function h(){let[e,n]=(0,s.useState)("connecting"),[r,t]=(0,s.useState)(null),c=(0,s.useRef)(null),[l,h]=(0,s.useState)(null),[m,f]=(0,s.useState)(0),p=(0,s.useRef)(null);(0,s.useEffect)(()=>{let e="undefined"!=typeof crypto&&"randomUUID"in crypto?"web-".concat(crypto.randomUUID()):"web-".concat(Math.random().toString(16).slice(2),"-").concat(Date.now()),r=i.Z.connect(a,{clientId:e,clean:!0,reconnectPeriod:2e3,connectTimeout:3e4,keepalive:60,protocolVersion:4});return c.current=r,n("connecting"),t(null),r.on("connect",()=>{n("connected"),t(null)}),r.on("reconnect",()=>n("reconnecting")),r.on("close",()=>n("disconnected")),r.on("error",e=>{var r;console.error("MQTT error:",e),n("error"),t(null!==(r=null==e?void 0:e.message)&&void 0!==r?r:String(e))}),()=>{p.current&&clearInterval(p.current),r.end(!0)}},[]);let v=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5;p.current&&clearInterval(p.current),f(e),p.current=setInterval(()=>{f(e=>e<=1?(p.current&&clearInterval(p.current),p.current=null,0):e-1)},1e3)},T=(n,r)=>{if(!c.current||"connected"!==e&&"reconnecting"!==e||m>0)return;let o=JSON.stringify({command:"COINDROP",payload:{amount:n,drop_count:r}});h(n),t(null),c.current.publish(u,o,{qos:1},e=>{if(h(null),e){var n;console.error("Publish error:",e),t(null!==(n=null==e?void 0:e.message)&&void 0!==n?n:String(e));return}v(5)})},g=m>0?100-(m-0)/5*100:0,x=e=>{switch(e){case"connected":return"Connected";case"connecting":return"Connecting...";case"reconnecting":return"Reconnecting...";case"disconnected":return"Disconnected";case"error":return"Error"}};return(0,o.jsx)("main",{className:"center",children:(0,o.jsxs)("section",{className:"card","aria-live":"polite",children:[(0,o.jsxs)("div",{className:"header",children:[(0,o.jsx)("h1",{className:"title",children:"Payment Simulation (MQTT)"}),(0,o.jsxs)("span",{className:"status",title:x(e),children:[(0,o.jsx)("span",{className:"dot ".concat(e)}),(0,o.jsx)("strong",{children:x(e)})]})]}),(0,o.jsxs)("div",{className:"topic",children:[(0,o.jsxs)("div",{children:[(0,o.jsx)("strong",{children:"Broker"}),": ",(0,o.jsx)("span",{className:"mono",children:a})]}),(0,o.jsxs)("div",{children:[(0,o.jsx)("strong",{children:"Topic"}),": ",(0,o.jsx)("span",{className:"mono",children:u})]})]}),(0,o.jsx)("div",{className:"btn-row",children:d.map(n=>{let{label:r,amount:t,drop:c}=n,s="connected"!==e||m>0||null!==l,i=l===t;return(0,o.jsxs)("button",{className:"btn",disabled:s,onClick:()=>T(t,c),"aria-busy":i,"aria-label":"Publish ".concat(r),children:[i?(0,o.jsx)("span",{className:"spinner","aria-hidden":!0}):null,(0,o.jsx)("span",{children:r})]},t)})}),m>0&&(0,o.jsxs)("div",{className:"cooldown",role:"status","aria-live":"polite",children:[(0,o.jsx)("strong",{children:"Cooldown:"}),(0,o.jsx)("div",{className:"bar","aria-hidden":!0,children:(0,o.jsx)("span",{style:{"--pct":"".concat(g,"%")}})}),(0,o.jsxs)("span",{className:"mono",children:[m,"s"]})]}),r&&(0,o.jsxs)("div",{style:{marginTop:12,color:"var(--bad)"},children:[(0,o.jsx)("strong",{children:"MQTT Error:"})," ",(0,o.jsx)("span",{className:"mono",children:r})]}),(0,o.jsxs)("div",{className:"footer",children:[(0,o.jsx)("span",{className:"muted",children:"Payload รูปแบบ:"}),(0,o.jsx)("code",{className:"code",children:'{\n  "command": "COINDROP",\n  "payload": { "amount": <30|40|50>, "drop_count": <3|4|5> }\n}'})]})]})})}},5566:function(e){var n,r,t,c=e.exports={};function o(){throw Error("setTimeout has not been defined")}function s(){throw Error("clearTimeout has not been defined")}function i(e){if(n===setTimeout)return setTimeout(e,0);if((n===o||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(r){try{return n.call(null,e,0)}catch(r){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:o}catch(e){n=o}try{r="function"==typeof clearTimeout?clearTimeout:s}catch(e){r=s}}();var l=[],a=!1,u=-1;function d(){a&&t&&(a=!1,t.length?l=t.concat(l):u=-1,l.length&&h())}function h(){if(!a){var e=i(d);a=!0;for(var n=l.length;n;){for(t=l,l=[];++u<n;)t&&t[u].run();u=-1,n=l.length}t=null,a=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===s||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(n){try{return r.call(null,e)}catch(n){return r.call(this,e)}}}(e)}}function m(e,n){this.fun=e,this.array=n}function f(){}c.nextTick=function(e){var n=Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)n[r-1]=arguments[r];l.push(new m(e,n)),1!==l.length||a||i(h)},m.prototype.run=function(){this.fun.apply(null,this.array)},c.title="browser",c.browser=!0,c.env={},c.argv=[],c.version="",c.versions={},c.on=f,c.addListener=f,c.once=f,c.off=f,c.removeListener=f,c.removeAllListeners=f,c.emit=f,c.prependListener=f,c.prependOnceListener=f,c.listeners=function(e){return[]},c.binding=function(e){throw Error("process.binding is not supported")},c.cwd=function(){return"/"},c.chdir=function(e){throw Error("process.chdir is not supported")},c.umask=function(){return 0}}},function(e){e.O(0,[793,971,23,744],function(){return e(e.s=9552)}),_N_E=e.O()}]);